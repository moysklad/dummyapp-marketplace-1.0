# Демо-приложение на PHP для Маркетплейса МоегоСклада

Демо-приложение предназначено для демонстрации взаимодействия приложений с Маркетплейсом МоегоСклада. 

В демо-приложении реализованы следующие функции:
* Активация (с получением токена доступа к JSON API 1.2) и деактивация по Vendor API
* Использование iframe для настройки приложения администратором аккаунта с обновлением статуса в Маркетплейсе
* Получение контекста пользователя для iframe (отображение информации по пользователю, проверка прав администратора)
* Получение информации из МоегоСклада по JSON API 1.2 с доступом по токену

ВНИМАНИЕ! Демо-приложение предназначено для ознакомления с функционалом Маркетплейса МоегоСклада и вопросы 
безопасности и стабильности его работы не рассматривались в рамках его разработки.

## Настройка (конфигурирование) приложения

Перед использованием приложения нужно настроить следующие конфигурационные параметры:

* `appId`                           - идентификатор приложения в Маркетплейсе
* `appUid`                          - appUid приложения в  в Маркетплейсе
* `secretKey`                       - секретный ключ для подписи JWT
* `appBaseUrl`                      - базовый URL приложения, должен указывать на содержимое `./src/php` (сейчас используется при генерации дескриптора)
* `moyskladVendorApiEndpointUrl`    - URL ендпоинта Vendor API 1.0 на стороне МоегоСклада 
* `moyskladJsonApiEndpointUrl`      - URL ендпоинта JSON API 1.2 на стороне МоегоСклада 

Для настройки конфигурационных параметров нужно скопировать файл `config.tpl.php` в файл `config.php` 
и указать ваши актуальные значения в файле `config.php`.

## Структура файлов приложения

### Основные файлы приложения

* `config.php`            - текущая конфигурация
* `config.tpl.php`        - заготовка файла конфига
* `iframe.html.php`       - HTML-шаблон содержимого iframe
* `iframe.php`            - контроллер отображения содержимого iframe
* `jwt.lib.php`           - JWT PHP библиотека (копипаст из https://github.com/firebase/php-jwt)
* `lib.php`               - общие классы приложения (конфигурация, модели данных, врапперы доступа к АПИ МоегоСклада)
* `update-settings.php`   - контроллер обновления настроек 
* `vendor-endpoint.php`   - контроллер REST-endpoint'a Vendor API на стороне вендора

### Утилиты

В комплекте с приложением идут два утилитных скрипта:

* `utils/generate-descriptor.php`     - генерация дескриптора приложения в соответствии с текущей конфигурацией
* `utils/generate-jwt.php`            - генерация JWT-токена (например, для выполнения запросов через Postman) 

### Логи

Логи записываются в файл `logs/log.txt`

### Данные

Состояние приложений хранится в файловой системе (сериализацией) по одному файлу на каждый экземпляр приложения в `data/*.app` 
